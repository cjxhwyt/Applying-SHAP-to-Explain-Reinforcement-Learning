# From Kernel to Permutation Estimator: Applying SHAP to Explain Reinforcement Learning in Online Advertising
This repository contains the main files for my master's dissertation project (submitted in August 2023) at The University of Edinburgh. The project is industry-supported by Amazon, supervised by Ben Allison, Doudou Tang and Robert Hu, and coordinated by Prof Iain Murray.

## Project Introduction
This project aims to explore how [SHapley Additive exPlanations](https://papers.nips.cc/paper/2017/hash/8a20a8621978632d76c43dfd28b67767-Abstract.html) (**SHAP**), a model-agnostic eXplainable Artificial Intelligence (XAI) method, can explain the behaviours of Reinforcement Learning (**RL**) bidding agents.

### Motivation and Background
[Learning to bid with AuctionGym](https://www.amazon.science/publications/learning-to-bid-with-auctiongym) formulates bidders (advertisers) participating in online advertising auctions as RL agents, whose rewards are utilities that can be estimated. This paper also proposes an auction simulation environment - [AuctionGym](https://github.com/amzn/auction-gym), which supports the use of RL bidders in such auctions. In a simulated auction round, an advertisement opportunity is described by context features. Since real data is not available due to its proprietary and sensitive nature, context features are generated by sampling from data distributions.

While RL has proven to be an effective technique for optimising bidding strategies, its lack of transparency prevents humans from trusting and using it. In this project, we would like to mitigate the problem by employing SHAP. SHAP can fairly assign feature importance/contributions toward a model prediction. Given the computational complexity of precise SHAP value calculations, we focus on two SHAP value estimators - Kernel and Permutation.

### Methodology
We develop a three-step pipeline:
1.  Train a bidder (RL model) in AuctionGym given its configuration file.
2.  Generate data for explanation, with context features following the same data distributions as during training.
3.  Apply SHAP to explain how the bidder behaves on each data instance.

In addition, we also visualise SHAP values through plots and dashboards.

## File Structure
As this project is based on [AuctionGym](https://github.com/amzn/auction-gym), we make modifications to some AuctionGym settings and implement the application of SHAP to bidder models. The project's file structure is organised as follows:

### Modification of AuctionGym
- [src](https://github.com/cjxhwyt/Applying-SHAP-to-Explain-Reinforcement-Learning/tree/main/src)/[Auction.py](https://github.com/cjxhwyt/Applying-SHAP-to-Explain-Reinforcement-Learning/blob/main/src/Auction.py): passing ``true_context`` as a parameter of ``simulate_opportunity()``, enabling the use of customised context features for advertisement opportunities.
- [config](https://github.com/cjxhwyt/Applying-SHAP-to-Explain-Reinforcement-Learning/tree/main/config): adding configurations for 11 bidders, named as [Auction Type]\_[Utility Estimator]\_[Number of Observable Context Features],
	- Auction Type: **FP** (First-Price), **SP**(Second-Price);
	- Utility Estimator: **DM** (Direct Method), **IPS** (Inverse Propensity Score), **DR** (Doubly Robust);
	- Number of Observable Context Features: **4**/**8**/**16**/**24**/**32**/**40** (**f**eatures).
- [requirements.txt](https://github.com/cjxhwyt/Applying-SHAP-to-Explain-Reinforcement-Learning/blob/main/requirements.txt): resolving the NumPy version conflict and adding packages for SHAP.
- [README.md](https://github.com/cjxhwyt/Applying-SHAP-to-Explain-Reinforcement-Learning/blob/main/README.md): updating, the original version can be found [here](https://github.com/amzn/auction-gym/blob/main/README.md) .

### Implementation of SHAP Application

 - [pipeline](https://github.com/cjxhwyt/Applying-SHAP-to-Explain-Reinforcement-Learning/tree/main/pipeline)
	 1. [train_bidder.py](https://github.com/cjxhwyt/Applying-SHAP-to-Explain-Reinforcement-Learning/blob/main/pipeline/train_bidder.py)
	 2. [data_generation.py](https://github.com/cjxhwyt/Applying-SHAP-to-Explain-Reinforcement-Learning/blob/main/pipeline/data_generation.py)
	 3. [SHAP Value Estimator]SHAP&#46;py using [`shap`](https://github.com/shap/shap) and [SHAP_special.py](https://github.com/cjxhwyt/Applying-SHAP-to-Explain-Reinforcement-Learning/blob/main/pipeline/SHAP_special.py)
 - [visualisation](https://github.com/cjxhwyt/Applying-SHAP-to-Explain-Reinforcement-Learning/tree/main/visualisation)
 - examples
	 - [training](https://github.com/cjxhwyt/Applying-SHAP-to-Explain-Reinforcement-Learning/tree/main/training)
	 - [model](https://github.com/cjxhwyt/Applying-SHAP-to-Explain-Reinforcement-Learning/tree/main/model)
	 - [data](https://github.com/cjxhwyt/Applying-SHAP-to-Explain-Reinforcement-Learning/tree/main/data)
	 - [shap](https://github.com/cjxhwyt/Applying-SHAP-to-Explain-Reinforcement-Learning/tree/main/shap)
	 - [dashboard](https://github.com/cjxhwyt/Applying-SHAP-to-Explain-Reinforcement-Learning/tree/main/dashboard)
 - [figure](https://github.com/cjxhwyt/Applying-SHAP-to-Explain-Reinforcement-Learning/tree/main/figure)

## Reproducing Research Results
### Pipeline
`cd pipeline`

`python train_bidder.py FP_DR_40f.json specific True False`

`python data_generation.py FP_DR_40f.json specific True 1000`

`python permutationSHAP.py FP_DR_40f.json specific True 1000`  

### Dashboard
`cd visualisation`

`python dashboard_SHAP.py FP_DR_40f.json specific True 1000`
